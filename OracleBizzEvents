# Set variables

subscriptionId="$(az account show --query id -o tsv)"
location=westeurope
resourcegroup=Oracle
topicname=oracle
crsendpoint=https://oracle-bizz-crs.azurewebsites.net
payendpoint=https://oracle-bizz-pay.azurewebsites.net
postendpoint=https://connect-post.azurewebsites.net
dataendpoint=https://connect-data.azurewebsites.net/log
getendpoint=https://connect-get.azurewebsites.net

# Delete existing eventgrid topic
echo "Delete topic $topicname"
az eventgrid topic delete -g $resourcegroup --name $topicname

# Create eventgrid topic
echo "Create topic $topicname"
az eventgrid topic create --name $topicname -l $location -g $resourcegroup --output none

# Create system event subscriptions
echo "Create system event subscriptions in $topicname"
az eventgrid event-subscription create \
  --output none \
  --source-resource-id "/subscriptions/$subscriptionId/resourceGroups/$resourcegroup/providers/Microsoft.EventGrid/topics/$topicname" \
  --name SysPurgeLog \
  --endpoint $dataendpoint \
  --included-event-types "$resourcegroup.PurgLog.Requested"

# Create Get event subscriptions
echo "Create Get event subscriptions in $topicname"
az eventgrid event-subscription create \
  --output none \
  --source-resource-id "/subscriptions/$subscriptionId/resourceGroups/$resourcegroup/providers/Microsoft.EventGrid/topics/$topicname" \
  --name GetReport \
  --endpoint $getendpoint \
  --included-event-types "$resourcegroup.Report.Required"

if [ $topicname = 'louvre' ]; then
  az eventgrid event-subscription create \
    --output none \
    --source-resource-id "/subscriptions/$subscriptionId/resourceGroups/$resourcegroup/providers/Microsoft.EventGrid/topics/$topicname" \
    --name GetResult \
    --endpoint $getendpoint \
    --included-event-types "$resourcegroup.Result.Required"
fi

if [ $topicname = 'pms' ]; then
  az eventgrid event-subscription create \
    --output none \
    --source-resource-id "/subscriptions/$subscriptionId/resourceGroups/$resourcegroup/providers/Microsoft.EventGrid/topics/$topicname" \
    --name GetReservation \
    --endpoint $getendpoint \
    --included-event-types "$resourcegroup.Reservation.Required"

  az eventgrid event-subscription create \
    --output none \
    --source-resource-id "/subscriptions/$subscriptionId/resourceGroups/$resourcegroup/providers/Microsoft.EventGrid/topics/$topicname" \
    --name GetInventory \
    --endpoint $getendpoint \
    --included-event-types "$resourcegroup.Inventory.Required"
    
  az eventgrid event-subscription create \
    --output none \
    --source-resource-id "/subscriptions/$subscriptionId/resourceGroups/$resourcegroup/providers/Microsoft.EventGrid/topics/$topicname" \
    --name GetRates \
    --endpoint $getendpoint \
    --included-event-types "$resourcegroup.Rates.Required"
fi

# Create CRS event subscriptions
echo "Create CRS event subscriptions in $topicname"
az eventgrid event-subscription create \
  --output none \
  --source-resource-id "/subscriptions/$subscriptionId/resourceGroups/$resourcegroup/providers/Microsoft.EventGrid/topics/$topicname" \
  --name CrsBizzBusinessPrepared \
  --endpoint $crsendpoint \
  --included-event-types "$resourcegroup.Business.Prepared"
  
az eventgrid event-subscription create \
  --output none \
  --source-resource-id "/subscriptions/$subscriptionId/resourceGroups/$resourcegroup/providers/Microsoft.EventGrid/topics/$topicname" \
  --name CrsBizzRefreshPrepared \
  --endpoint $crsendpoint \
  --included-event-types "$resourcegroup.Refresh.Prepared"

# Create CRS Post event subscriptions
echo "Create CRS Post event subscriptions in $topicname"
az eventgrid event-subscription create \
  --output none \
  --source-resource-id "/subscriptions/$subscriptionId/resourceGroups/$resourcegroup/providers/Microsoft.EventGrid/topics/$topicname" \
  --name CrsPostProxyProcessed \
  --endpoint $postendpoint \
  --included-event-types "$resourcegroup.Proxy.Processed"
    
az eventgrid event-subscription create \
  --output none \
  --source-resource-id "/subscriptions/$subscriptionId/resourceGroups/$resourcegroup/providers/Microsoft.EventGrid/topics/$topicname" \
  --name CrsPostBusinessProcessed \
  --endpoint $postendpoint \
  --included-event-types "$resourcegroup.Business.Processed"
      
az eventgrid event-subscription create \
  --output none \
  --source-resource-id "/subscriptions/$subscriptionId/resourceGroups/$resourcegroup/providers/Microsoft.EventGrid/topics/$topicname" \
  --name CrsPostReservationCommit \
  --endpoint $postendpoint \
  --included-event-types "$resourcegroup.Commit.Requested"
        
az eventgrid event-subscription create \
  --output none \
  --source-resource-id "/subscriptions/$subscriptionId/resourceGroups/$resourcegroup/providers/Microsoft.EventGrid/topics/$topicname" \
  --name CrsPostReservationPush \
  --endpoint $postendpoint \
  --included-event-types "$resourcegroup.Push.Requested"
